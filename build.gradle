plugins {
    id 'java'
    id 'org.jetbrains.intellij' version '0.4.11'
    id 'org.jetbrains.kotlin.jvm' version '1.3.50'
    id "com.diffplug.gradle.spotless" version "3.25.0"
    id 'com.github.ben-manes.versions' version "0.27.0"
}

apply plugin: 'idea'
apply plugin: 'org.jetbrains.intellij'
apply plugin: 'java'

group project.GROUP
version project.VERSION

sourceCompatibility = 1.8

repositories {
    mavenCentral()
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
    testCompile group: 'junit', name: 'junit', version: '4.12'
}

compileKotlin {
    kotlinOptions.jvmTarget = "1.8"
}
compileTestKotlin {
    kotlinOptions.jvmTarget = "1.8"
}
intellij {
    plugins = ['Kotlin', 'git4idea', 'android']
    updateSinceUntilBuild false
    localPath ASRunPath
}

allprojects {
    apply plugin: 'com.diffplug.gradle.spotless'
    spotless {
        kotlin {
            target "**/*.kt"
            ktlint('0.35.0')
        }
        java {
            target "**/*.java"
            googleJavaFormat('1.1').aosp()
        }
    }
}

tasks.withType(Jar) {
    destinationDir = file("$rootDir/distribution")
}
patchPluginXml {
    buildPlugin.doLast {
        File zipFile = project.tasks.findByName("buildPlugin").outputs.files[0]

        File template = new File("$rootDir/placeholder/updatePlugins_tmpl.xml")
        String templateContent = new StringBuffer(template.text.toString())
        templateContent = templateContent.replaceAll("#package", GROUP)
        templateContent = templateContent.replaceAll("#filename", zipFile.getName().replace("zip","jar"))
        templateContent = templateContent.replaceAll("#version", VERSION)
        templateContent = templateContent.replaceAll("#name", (project.NAME as String).replace("\"", ""))
        templateContent = templateContent.replaceAll("#description", (project.DESCRIPTION as String).replace("\"", ""))

        File output = new File('distribution/updatePlugins.xml')
        output.getParentFile().mkdir()
        output.createNewFile()
        output.text = templateContent
    }
}